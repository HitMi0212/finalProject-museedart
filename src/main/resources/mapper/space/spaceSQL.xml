<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="space">
	<insert id="insertSpace" parameterType="space">
		insert
			into space
			values(space_seq.nextval,#{spaceName},#{spacePurpose},#{mainFacility},#{mainProduct},#{maxPeople},#{price},'N')
			<selectKey resultType="_int" order="AFTER" keyProperty="spaceNo">
				select max(space_no) from space
			</selectKey>
	</insert>
	<select id="selectSpaceNo" resultType="_int">
		select
			max(space_no)
			from space
	</select>
	<insert id="insertFile" parameterType="fv">
		insert
			into space_file 
			values(space_file_seq.nextval,#{spaceNo},#{filename},#{filepath},
			<choose>
				<when test="thumbnail == null">
					'N'
				</when>			
			<otherwise>
				'Y'
			</otherwise>
			</choose>
			)
	</insert>
	<insert id="insertSpaceTime" parameterType="kr.or.space.model.vo.SpaceTime">
		insert
			into space_time
			values(st_seq.nextval,#{spaceNo},#{startTime},#{endTime})
	</insert>
	<select id="selectAllSpace" resultType="space">
		select
			space_no as spaceNo,
			space_name as spaceName,
			space_purpose as spacePurpose,
			main_facility as mainFacility,
			main_product as mainProduct,
			max_people as maxPeople,
			price
		from space
		where del_yn like 'N' 	
	</select>
	<select id="selectFile" resultType="fv">
		select
			space_no as spaceNo,
			filename,
			filepath,
			thumbnail
		from space_file	
		where thumbnail like 'Y'
	</select>
	<select id="selectOneSpace" resultType="space" parameterType="_int">
		select
			space_no as spaceNo,
			space_name as spaceName,
			space_purpose as spacePurpose,
			main_facility as mainFacility,
			main_product as mainProduct,
			max_people as maxPeople,
			price
		from space
		where del_yn like 'N' and space_no=#{spaceNo}
	</select>
	<select id="selectSpaceFile" resultType="fv" parameterType="_int">
		select
			space_no as spaceNo,
			filename,
			filepath,
			thumbnail
		from space_file	
		where thumbnail like 'N' and space_no=#{spaceNo}
	</select>
	<select id="selectThumbnail" parameterType="_int" resultType="fv">
		select
			space_no as spaceNo,
			filename,
			filepath,
			thumbnail
		from space_file	
		where thumbnail like 'Y' and space_no=#{spaceNo}	
	</select>
	<update id="deleteSpace" parameterType="_int">
		update
			space set 
			del_yn = 'Y'
			where space_no = #{spaceNo}
	</update>
	<select id="selectFileList" parameterType="_int" resultType="fv">
		select
			space_no as spaceNo,
			filename,
			filepath,
			thumbnail
		from space_file	
		where space_no = #{spaceNo}
	</select>
	<select id="selectSpaceTime" parameterType="_int" resultType="kr.or.space.model.vo.SpaceTime">
		select
			st_no as stNo,
			space_no as spaceNo,
			start_time as startTime,
			end_time as endTime
		from space_time
		where space_no = #{spaceNo}	
	</select>
	<select id="selectOneTime" parameterType="_int" resultType="kr.or.space.model.vo.SpaceTime">
		select
			st_no as stNo,
			space_no as spaceNo,
			start_time as startTime,
			end_time as endTime
		from space_time
		where st_no = #{stNo}	
	</select>
	<insert id="insertRental" parameterType="rental">
		insert
			into rental
			values(rental_seq.nextval,#{spaceNo},#{memberId},#{stNo},#{rentalDate},#{rentalPeople},1,0)
	</insert>
	<select id="selectRentalList" parameterType="string" resultType="rental">
	<![CDATA[	
		select 
			r.rental_no as rentalNo,
			r.member_id as memberId,
			r.rental_date as rentalDate,
			r.rental_status as rentalStatus, 
			s.space_name as spaceName, 
			r.used_board as usedBoard, 
			st.end_time 
		from rental r 
		join space s using(space_no)  
		join space_time st using(st_no) 
		where rental_date < to_char(sysdate,'yyyy-mm-dd') 
		and end_time < to_char(sysdate , 'HH24:mm') 
		and member_id = #{memberId} 
		and used_board = 0 
		and rental_status =2
	]]>
	</select>
	<select id="selectRentalNo" parameterType="_int" resultType="rental">
		select
			rental_no as rentalNo,
			space_name as spaceName,
			member_id as memberId,
			st_no as stNo,
			rental_date as rentalDate,
			rental_people as rentalPeople,
			rental_status as rentalStatus,
			used_board as usedBoard
		from rental
		join space using (space_no)
		where rental_no=#{rentalNo}
	</select>
	<select id="selectAllRental"  resultType="kr.or.space.model.vo.SpaceAdmin">
		select
			rental_no as rentalNo,
			space_name as spaceName,
			member_id as memberId,
			start_time as startTime,
			end_time as endTime,
			rental_date as rentalDate,
			rental_people as rentalPeople,
			filename,
			rental_status as rentalStatus,
			used_board as usedBoard
		from rental 
		join space using(space_no) 
		join space_file using(space_no) 
		join space_time using(st_no) 
		where thumbnail = 'Y'
	</select>
	<update id="updateRentalStatus" parameterType="_int">
		update
			rental set
			rental_status = 2
		where rental_no = #{rentalNo}	 
	</update>
	<select id="selectResSpace" parameterType="_int" resultType="kr.or.space.model.vo.ResSpace">
		 select 
			 rental.space_no as spaceNo, 
			 st_no as stNo,
			 rental_date as rentalDate, 
			 start_time as startTime, 
			 end_time as endTime 
		from rental 
		join space_time using (st_no) 
		where rental.space_no=#{spaceNo} 
		order by start_time
	</select>
	<select id="selectResList" parameterType="map" resultType="kr.or.space.model.vo.ResSpace">
		select 
			rental.space_no as spaceNo,
			st_no as stNo, 
			rental_date as rentalDate, 
			start_time as startTime, 
			end_time as endTime 
		from rental 
		join space_time using (st_no) 
		where rental.space_no=#{spaceNo} and rental_date=#{selectDate} 
		order by start_time
	</select>
	<select id="selectSpaceMypage" parameterType="string" resultType="kr.or.space.model.vo.SpaceMypage">
		select  
			rental_no as rentalNo, 
			space_name as spaceName,  
			start_time as startTime, 
			end_time as endTime,
			rental_date as rentalDate,
			space_purpose as spacePurpose,
			main_facility as mainFacility, 
			main_product as mainProduct, 
			max_people as maxPeople, 
			price,
			rental_people as rentalPeople,
			rental_status as rentalStatus 
		from rental 
		join space using(space_no) 
		join space_time using (st_no)  
		where member_id =#{memberId}
	</select>
	<select id="selectUseBoardList" parameterType="map" resultType="kr.or.space.model.vo.UseBoard">
		 select 
		 	ub_no as ubNo, 
		 	space_name as spaceName, 
		 	use_board.member_id as memberId, 
		 	ub_title as ubTitle, 
		 	ub_content ubContent, 
		 	ub_date ubDate, 
		 	filename 
		 	filepath
		 from use_board 
		join rental using(rental_no) 
		join space using(space_no)
	</select>
	<select id="selectTotalCount" resultType="_int">
		select 
			count(*) as cnt 
		from use_board
	</select>
	<insert id="insertUseBoard" parameterType="kr.or.space.model.vo.UseBoard">
		insert
			into use_board
			values(ub_seq.nextval,#{rentalNo},#{memberId},#{ubTitle},#{ubContent},sysdate,#{filename},#{filepath})
	</insert>
	<update id="updateUseBoard" parameterType="_int">
		update
			rental set
			used_board = 1
		where rental_no=#{rentalNo}	
	</update>
</mapper>
